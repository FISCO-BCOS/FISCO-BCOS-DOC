# PBFT

## 1. 名词解释

### 1.1 PBFT

**PBFT**(Practical Byzantine Fault Tolerance) 是一个在少数节点作恶(如伪造消息)场景中可以达到一致性的共识算法，它采用密码学相关技术(如签名算法、签名验证算法、哈希算法等)确保消息传递过程中的防篡改性、防伪造性、不可抵赖性，并基于前人工作进行优化，将拜占庭容错算法复杂度从指数级降低到多项式级别，在一个由(3\*f+1)个节点构成的系统中，只要有(2\*f+1)个非恶意节点正常工作，该系统就能达成一致性意见。例如，7个节点的系统中允许2个节点出现拜占庭错误。

### 1.2 节点类型

- **Leader/Primary**: 出块节点，主要负责将客户端发送的交易打包成区块，并将区块广播给副本节点，经过三阶段共识后，将产生的区块上链。每轮共识过程中有且仅有一个leader，为了防止leader伪造区块，PBFT算法中每轮共识后，均会切换leader.
- **Replica**: 副本节点，负责从出块节点接收区块，经过三阶段共识后，将产生的区块上链。每轮共识过程中有多个Replica节点，每个Replica节点的处理过程类似。
- **Observer**: 观察者节点，负责从出块节点或副本节点获取最新区块，执行并验证区块执行结果后，将产生的区块上链。

其中Leader和Replica统称为共识节点。


### 1.3 节点ID && 节点索引

为了防止节点作恶，PBFT算法采用数字签名、哈希算法等确保消息传递过程中的防篡改性、防伪造性和不可抵赖性。由于每个共识节点均要对其发送的消息进行签名，对收到的消息包进行验签名，因此每个节点均维护一份公私钥对，私钥用于对发送的消息进行签名，公钥作为节点ID，其他节点收到该节点消息包后，使用其节点ID对消息包进行验签。

- **节点ID** : 节点签名公钥，同时作为共识节点的唯一标识, 一般是64字节的二进制串，其他节点使用消息包发送者的节点ID对消息包进行验签。

考虑到节点ID很长，在共识消息包中包含该字段会耗费部分网络带宽，FISCO BCOS引入了节点索引。每个共识节点维护一份公共的共识节点列表，节点索引记录了每个共识节点ID在这个列表中的位置，发送网络消息包时，只需要带上节点索引，其他节点即可以从公共的共识节点列表中索引出节点的ID，进而对消息进行验签:

- **节点索引** : 每个共识节点ID在这个公共节点ID列表中的位置。 


### 1.4 视图(view)

PBFT算法中，存在视图的概念，在一个视图中，每个共识节点都维护这相同的Leader和Replicas节点列表，若Leader出现故障，视图关系就会切换，若视图切换成功(至少2\*f+1个节点达到相同的视图)，则根据新的视图选出新的leader，新leader开始出块，否则继续进行视图切换，直至全网大部分节点(大于等于2\*f+1)达到一致视图。
若节点均切换到一致

FISCO-BCOS系统中，leader索引的计算公式如下：

```bash
leader_idx = (view + block_number) % node_num
```


下图简单展示了4(3\*1+1, f=1)节点FISCO BCOS系统中，node3为拜占庭节点情况下，视图切换过程：



```eval_rst

.. image:: ../../images/consensus/pbftView.png

```


- 前三轮共识过程中, node0、node1、node2分别为Leader，正常出块共识;
- 第四轮共识过程中, node3为Leader，但node3已经无法提供正常服务，node0-node2在给定时间内未收到node3打包的区块，会触发视图切换，将当前view+1，记为view\_new，并相互间广播viewchange包，其他节点收集满在视图view\_new上的(2\*f+1)个viewchange包后，将自己的view切换成view\_new，并计算出新leader
- node0为第五轮共识leader，继续打包出块。


### 1.4 消息

PBFT模块主要包括四种网络消息**PrepareReq、SignReq、CommitReq和ViewChangeReq**：

- **PrepareReqPacket**: 包含区块信息的请求包，由Leader产生并向所有Replica节点广播，Replica节点收到Prepare包后，验证PrepareReq签名执行并缓存区块，用于防止拜占庭节点作恶、保证区块执行结果的最终确定性。

- **SignReqPacket**: 带上区块执行结果的签名请求，由收到Prepare包并执行完区块的共识节点产生，SignReq请求会带上执行后区块的hash以及该hash的签名，分别记为SignReq.block_hash和SignReq.sig。节点将SignReq广播到所有其他共识节点后，其他节点对SignReq(即区块执行结果)进行共识。

- **CommitReqPacket**: 用于确认区块执行结果的提交请求，由收集满(2\*f+1)个block_hash相同且来自不同节点SignReq请求的节点产生。CommitReq被广播给所有其他共识节点；其他节点收集满(2\*f+1)个block_hash相同、来自不同节点的CommitReq后，将本地节点缓存的区块上链。

- **ViewChangeReqPacket**: 视图切换请求。当Leader无法提供正常服务(如网络连接不正常、服务器宕机等)时, 其他共识节点会主动触发视图切换，ViewChangeReq中会带上该节点即将切换到的视图(记为toView，为当前视图加一)，当某节点收集满(2\*f+1)个视图等于toView、来自不同节点的ViewChangeReq后，会将当前视图切换为toView。

这四类消息包包含的字段大致相同，所有消息包共有的字段如下：

```eval_rst

+----------------+-----------------------------------------------------------------------------------+
| 字段名         | 字段含义                                                                          |
+================+===================================================================================+
| idx            | 当前节点索引                                                                      | 
+----------------+-----------------------------------------------------------------------------------+
| packetType     | 请求包类型(包括PrepareReqPacket/SignReqPacket/CommitReqPacket/ViewChangeReqPacket)| 
+----------------+-----------------------------------------------------------------------------------+
| height         | 当前正在处理的区块高度(一般是本地区块高度加一)                                    |
+----------------+-----------------------------------------------------------------------------------+
| blockHash      | 当前正在处理的区块哈希                                                            |
+----------------+-----------------------------------------------------------------------------------+
| view           | 当前节点所处的视图                                                                |
+----------------+-----------------------------------------------------------------------------------+
| sig            | 当前节点对blockHash的签名                                                         |
+----------------+-----------------------------------------------------------------------------------+
```

PrepareReqPacket类型消息包包含了正在处理的区块信息:


```eval_rst

+--------------------+--------------+--------------------------------+
| 消息包类型         | 字段名       | 字段含义                       |
+====================+==============+================================+
| PrepareReqPacket   | block        | 所有共识节点正在共识的区块数据 |
+--------------------+--------------+--------------------------------+

```

## 2. 系统框架

系统框架如下图:


```eval_rst

.. image:: ../../images/consensus/pbftArchitecture.png

```
PBFT共识主要包括两个模块:

- PBFT Sealer: 

- PBFT Engine:


Raft Sealer：负责从交易池取出交易并打包成区块，并发送至Raft Engine进行共识。区块上链后，Raft Sealer负责从交易池中删除已上链交易；
Raft Engine：负责在共识节点进行共识，将达成共识的区块上链。

## 3. 核心流程
